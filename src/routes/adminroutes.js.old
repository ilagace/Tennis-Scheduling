var express = require('express');

var mongodb = require('mongodb').MongoClient;

var adminrouter = express.Router();

var router = function(nav) {

    adminrouter.route('/addphotos').get(function(req, res) {

        //  To do a walkthrough of all the photos for my web site
        var walk = require('walk'),
            options, walker;

        options = {
            followLinks: false,
            // directories with these keys will be skipped                 ,
            filters: ['thumb']
        };

        //  To read the exif data on most recent photos
        var ExifImage = require('exif').ExifImage;
        function sleep(time, callback) {
            var stop = new Date().getTime();
            while (new Date().getTime() < stop + time) {
                ;
            }
            callback();
        }

        // To read the txt file with description
        var fs = require('fs');

        //  Build an array of data for each photos on the web site
        var imagetype = ['.jpg', 'JPG','.bmp'];
        var photocounter = 0;

        var url = 'mongodb://localhost:27017/library';

        //  This code is meant to be run on the local machine to update the database and then copy the database to the web server
//        walker = walk.walk('D:\\Web\\Web site\\Yvan\\Turk\ and\ Caicos', options);
        walker = walk.walk('D:\\Web\\Web site\\Yvan\\Agra\ 1990', options);

        walker.on('directories', function(root, dirStatsArray, next) {
            // dirStatsArray is an array of `stat` objects with the additional attributes
            // * type
            // * error
            // * name
            next();
        });

        walker.on('file', function(root, fileStats, next) {
            var typetest = false;
            for (var i = 0; i < imagetype.length; i++) {
                typetest = typetest || fileStats.name.indexOf(imagetype[i]) !== -1;
            }
            if (root.indexOf('v8x6') !== -1 && typetest) {
                var dirSplit = root.split('\\');
                var path = dirSplit[0] +  '\\' + 'Web Photos\\my photos' + '\\' + dirSplit[3] +  '\\' + dirSplit[4] +  '\\' + fileStats.name;

                // Get the text for the description if it exists
                var pathtxt = root.slice(0,root.indexOf(dirSplit[5])) +
                            fileStats.name.slice(0,fileStats.name.indexOf('.')) +
                            '.txt';
                var text = null;
                if (fs.existsSync(pathtxt)) {
                    text = String(fs.readFileSync(pathtxt));
                    if (text.includes('Aucune description')) {
                        text = null;
                    }
                }

                // We are now inside the image folder and we check first if photo/video already in database
                mongodb.connect(url, function(err,db) {
                    var collection = db.collection('IvanPhotos');
                    collection.findOne({theme: dirSplit[3], folder: dirSplit[4], subfolder: dirSplit[5], filename: fileStats.name}, function(err, results) {
                        if (!results) {
                            var dirArray = [];
                            // if not in database build the complete data record
                            try {
                                var exifStat = new ExifImage({image : path}, function (error, exifData) {
                                    if (error) {

                                        // No exif data, get image size using image-size module
                                        var sizeOf = require('image-size');
                                        var dimensions = sizeOf(path);
                                        var fsmtime = JSON.stringify(fileStats.mtime);
                                        var datanoexif = {theme: dirSplit[3],
                                                    folder: dirSplit[4],
                                                    subfolder: dirSplit[5],
                                                    filename: fileStats.name,
                                                    description: text,
                                                    weblink: null,
                                                    exifDate: fsmtime.slice(1,11) + ' ' + fsmtime.slice(12,20),
                                                    year: null,
                                                    photoDimW: dimensions.width,
                                                    photoDimH: dimensions.height,
                                                    camera: 'Scanned',
                                                    gpsLatRef: null,
                                                    gpsLat: null,
                                                    gpsLongRef: null,
                                                    gpsLong: null,
                                                    };
                                        collection.insertOne(datanoexif);
//                                        dirArray.push(datanoexif);
                                        photocounter += 1;
                                    } else {
                                        // We have some exif data here
                                        var dataexif = {theme: dirSplit[3],
                                                folder: dirSplit[4],
                                                subfolder: dirSplit[5],
                                                filename: fileStats.name,
                                                description: text,
                                                weblink: null,
                                                exifDate: exifData.exif.DateTimeOriginal,
                                                year: null,
                                                photoDimW: exifData.exif.ExifImageWidth,
                                                photoDimH: exifData.exif.ExifImageHeight,
                                                camera: exifData.image.Model,
                                                gpsLatRef: exifData.gps.GPSLatitudeRef,
                                                gpsLat: exifData.gps.GPSLatitude,
                                                gpsLongRef: exifData.gps.GPSLongitudeRef,
                                                gpsLong: exifData.gps.GPSLongitude,
                                                };
                                        collection.insertOne(dataexif);
//                                        dirArray.push(dataexif);
                                        photocounter += 1;
                                    }
                                });
                            } catch (error) {
                                console.log('Error try: ' + error.message);
                            }
                        }
                    });
                });
            }
            next();
        });

        walker.on('errors', function(root, nodeStatsArray, next) {
            next();
        });

        walker.on('end', function() {
            console.log('folder walk completed with ' + photocounter + ' new items');

            // Write to database the new data
            mongodb.connect(url, function(err,db) {
                var collection = db.collection('IvanPhotos');
                dirArray.forEach(function(item,index) {
                    collection.insertOne(dirArray[index]);
                    if (index !== photocounter) {
                        // Wait .2 second before closing for async processes to catch up
                        sleep(200, function() {
                            console.log('Waiting to catch-up before closing', index, photocounter);
                        });
                    } else {
                        sleep(200, function() {
                            console.log('Waiting to catch-up before closing', index, photocounter);
                        });
                        db.close();
                    }
                });
            });
            res.render('editor', {dirArray: dirArray});
        });
    });

    adminrouter.route('/addphotosres').get(function(req, res) {
        var url = 'mongodb://localhost:27017/library';
        mongodb.connect(url, function(err,db) {
            var collection = db.collection('IvanPhotos');
            collection.find({}).toArray(function(err, results) {
                res.render('editor', {dirArray: results});
            });
        });
    });

    return adminrouter;

};

module.exports = router;
